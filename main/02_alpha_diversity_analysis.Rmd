---
title: "Alpha Diversity Analysis"
author: "Kuselah Tayaban"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Overview

This workflow analyzes alpha diversity of soil AMF community using common indices such as:

-   Observed richness

-   Shannon diversity

-   Evenness

```{r}
# Load packages
# Load libraries
library(readxl)
library(dplyr)
library(vegan)
library(car)
library(phyloseq)
library(ggplot2)
library(ggpubr)
```

## Data import and cleanup

```{r}
# Load data
otu<- read_excel("Expt01_asv_table.xlsx", sheet = "abund")
tax<- read_excel("Expt01_asv_table.xlsx", sheet = "tax")
data<-read_excel("Expt01_asv_table.xlsx", sheet = "metadata")
otu <- otu %>%
  tibble::column_to_rownames("OTU") 
tax <- tax %>%
  tibble::column_to_rownames("OTU") 
data <- data %>%
  tibble::column_to_rownames("Sample") 
otu <- as.matrix(otu)
tax <- as.matrix(tax)
# remove samples with <1000 reads
new_otu<-otu[,colSums(otu)>=1000]
new_data<-data[-c(50,46,27), ]
# # rarefy data
new_otu<-t(new_otu)
spAbund <- rowSums(new_otu)
spAbund
raremin <-min(spAbund)
raremin
sRare <- rarefy(new_otu, raremin)
sRare
set.seed(8765) # set random seed for reproducibility
otu_rare<-rrarefy(new_otu,sample = 1392)
```

Samples with less than 1000 reads were removed for further analysis. Data were rarefied to an even sequencing depth to control for differences in sequencing effort among soil samples and to enable unbiased comparison of AMF community diversity across treatments.

## Alpha diversity calculation

```{r}
# estimate alpha diversity using vegan
richness <- estimateR(otu_rare)
evenness <- diversity(otu_rare) / log(specnumber(otu_rare))
shannon <- diversity(otu_rare, index = "shannon")
alphadiv <- cbind(t(richness), shannon, evenness)
# add metadata
data<-data.frame(new_data)
alphadiv<-as.data.frame(alphadiv)
alphadiv$InoculationTreatment = data$InoculationTreatment
alphadiv$AMFInoculant = new_data$AMFInoculant
alphadiv$InoculationTiming = new_data$InoculationTiming
head(alphadiv)
# export 
write.csv2(alphadiv, file = "Expt01_alpha_diversity.csv")
```

## Statistical analysis

### Observed richness

```{r}
set.seed(56)
# test assumptions for ANOVA

# test homogeneity of variance
res.aov<-aov(S.obs~InoculationTreatment+AMFInoculant+
               InoculationTreatment*AMFInoculant,data = alphadiv)
# summary(res.aov) 
plot(res.aov,1) #3 outliers, normal, homogenous
leveneTest(S.obs~InoculationTreatment*AMFInoculant,data = alphadiv) # homogenous p>0.05

# test normality
plot(res.aov,2) # Q-Q plot
# Extract the residuals
aov_residuals <- residuals(object = res.aov)
# Run Shapiro-Wilk test
shapiro.test(x = aov_residuals) # p-value > 0.05 = normal

# One-way ANOVA richness
set.seed(78)
res.aov<-aov(log(S.obs)~InoculationTreatment+AMFInoculant+
               InoculationTreatment*AMFInoculant,data = alphadiv)
summary(res.aov) # not significant p > 0.05
```

### Shannon diversity

```{r}
set.seed(36)
# test assumptions for ANOVA
# test homogeneity of variance
res.aov<-aov(shannon~InoculationTreatment+AMFInoculant+
               InoculationTreatment*AMFInoculant,data = alphadiv)
summary(res.aov)
plot(res.aov,1) #3 outliers, normal, homogenous
leveneTest(shannon~InoculationTreatment*AMFInoculant,data = alphadiv) # homogenous p>0.05

# test normality
plot(res.aov,2) # Q-Q plot
# Extract the residuals
aov_residuals <- residuals(object = res.aov)
# Run Shapiro-Wilk test
shapiro.test(x = aov_residuals) # p-value >0.05 = normal

# One-way ANOVA Shannon
res.aov<-aov(log(shannon)~InoculationTreatment+AMFInoculant+
               InoculationTreatment*AMFInoculant,data = alphadiv)
summary(res.aov) # not significant p > 0.05
```

### Evenness

```{r}
set.seed(45)
# test assumptions for ANOVA
# test homogeneity of variance
res.aov<-aov(evenness~InoculationTreatment+AMFInoculant+
               InoculationTreatment*AMFInoculant,data = alphadiv)
summary(res.aov)
plot(res.aov,1) #3 outliers, normal, homogenous
leveneTest(evenness~InoculationTreatment*AMFInoculant,data = alphadiv) # homogenous p > 0.05

# test normality
plot(res.aov,2) # Q-Q plot
# Extract the residuals
aov_residuals <- residuals(object = res.aov)
# Run Shapiro-Wilk test
shapiro.test(x = aov_residuals) # p-value > 0.05 = normal

# One-way ANOVA evenness
set.seed(78)
res.aov<-aov(log(evenness)~InoculationTreatment+AMFInoculant+
               InoculationTreatment*AMFInoculant,data = alphadiv)
summary(res.aov) # not significant p > 0.05
```

## Visualization

### Taxa plots

```{r}
# build phyloseq object for genus
otu = otu_table(otu, taxa_are_rows = TRUE)
tax = tax_table(tax)
data = sample_data(data)
amf<-phyloseq(otu,tax,data)
amf
amfgenus<-amf%>%
  tax_glom(taxrank = "Genus")%>%
  transform_sample_counts(function(x) {x/sum(x)*100})%>%
  psmelt()

# build phyloseq object for family
amffam<-amf%>%
  tax_glom(taxrank = "Family")%>%
  transform_sample_counts(function(x) {x/sum(x)*100})%>%
  psmelt()

# build phyloseq object for VT
amfvt<-amf%>%
  tax_glom(taxrank = "Species")%>%
  transform_sample_counts(function(x) {x/sum(x)*100})
# Compile taxa by VT filtering low abundance data
amfvt_orders<-amfvt%>%
  psmelt()%>%
  filter(Abundance > 1.0)%>%
  arrange(desc(Family),desc(Genus),desc(Species))
# Sum remaining taxa with a relative abundance < 1% and make a new dataframe
Remainders <- (amfvt_orders) %>%
  group_by(Sample,Sample.2,SampleNumber,Treatment,
           InoculationTreatment,AMFInoculant,HarvestTime) %>% 
  summarise(Abundance = (100-sum(Abundance))) %>% 
  as.data.frame()
Remainders$Species<-"Others (VTs < 1%)"
Remainders$Genus<-"_VTs < 1%"
Remainders$Family<-"_VTs < 1%"
Remainders$Phylum<-"Glomeromycota"
Remainders$OTU<-"Others (VTs < 1%)"
#Join dataframes
VT_barchart <- full_join(amfvt_orders,Remainders)

# plot at genus level 
# arrange variables for genus matrix
amfgenus_ordered$AMFInoculant<-factor(amfgenus_ordered$AMFInoculant,
                                    levels = c("Control",
                                               "DAOM197198",
                                               "CC4","Cuba8"))
amfgenus_ordered$InoculationTiming<-factor(amfgenus_ordered$InoculationTiming,
                                           levels = c("no inoculation",
                                                      "pre-inoculation",
                                                      "co-inoculation",
                                                      "combination"))
p1<-ggplot(amfgenus_ordered,aes(x=InoculationTiming,
                                y=Abundance,
                                fill = fct_reorder(Genus,desc(Abundance))))+
  geom_bar(position = "stack",stat = "summary",fun = "mean",color = "white")+
  facet_grid(AMFInoculant~InoculationTiming,
             scales = "free",space = "free", switch = "x")+
  scale_fill_brewer(palette = "Paired")+
  theme_set(theme_bw(base_size = 20,base_family = ""))+
  theme(panel.border = element_rect(colour = "black"),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank(),
        strip.background = element_blank(),
        axis.text.x = element_blank(),axis.ticks.x = element_blank(),
        strip.text.x = element_text(angle = -65,hjust = 0))+
  labs(x="Inoculation Timing",y="Relative Abundance",
       fill="Genus")+
  scale_y_continuous(breaks = c(0,100))
p1
#save plot
ggsave(p1,filename="Figure3.3_taxa_plot_genus.png",dpi = 300,width = 5.5,
       height = 7,units = "in")

# plot at family level
amffam_ordered$AMFInoculant<-factor(amffam_ordered$AMFInoculant,
                                    levels = c("Control",
                                               "DAOM197198",
                                               "CC4","Cuba8"))
amffam_ordered$InoculationTiming<-factor(amffam_ordered$InoculationTiming,
                                           levels = c("no inoculation",
                                                      "pre-inoculation",
                                                      "co-inoculation",
                                                      "combination"))
p2<-ggplot(amffam_ordered,aes(x=InoculationTiming,y=Abundance,
                              fill = fct_reorder(Family,desc(Abundance))))+
  geom_bar(position = "stack",stat = "summary",fun = "mean", color = "white")+
  facet_grid(AMFInoculant~InoculationTiming,switch = "x",
             scales = "free",space = "free")+
  scale_fill_brewer(palette = "Paired")+
  theme_set(theme_bw(base_size = 20,base_family = ""))+
  theme(panel.border = element_rect(colour = "black"),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank(),
        strip.background = element_blank(),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        strip.text.x = element_text(angle = -65,hjust = 0))+
  labs(x="Inoculation Timing",y="Relative Abundance",
       fill = "Family")+
  scale_y_continuous(breaks = c(0,100))
p2
#save plot
ggsave(p2,filename="FigureB5_taxa_plot_family.png",dpi = 300,width = 5.5,
       height = 7,units = "in")

# plot at VT level
nb.cols<-45
mycolors <- colorRampPalette(brewer.pal(7, "Paired"))(nb.cols)
VT_barchart_ordered$AMFInoculant<-factor(VT_barchart_ordered$AMFInoculant,
                                         levels = c("Control",
                                                    "DAOM197198",
                                                    "CC4","Cuba8"))
VT_barchart_ordered$InoculationTiming<-factor(VT_barchart_ordered$InoculationTiming,
                                         levels = c("no inoculation",
                                                    "pre-inoculation",
                                                    "co-inoculation",
                                                    "combination"))
p3<-ggplot(VT_barchart_ordered,aes(x=InoculationTiming,y=Abundance,
                                   fill = fct_reorder(Species,desc(Abundance))))+
  geom_bar(position = "fill",stat = "summary", fun = "mean", color = "white")+
  facet_grid(AMFInoculant~InoculationTiming,switch = "x",
             scales = "free",space = "free")+
  scale_fill_manual(values = mycolors)+
  theme_set(theme_bw(base_size = 20,base_family = ""))+
  theme(panel.border = element_rect(colour = "black"),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank(),
        strip.background = element_blank(),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        strip.text.x = element_text(angle = -65,hjust = 0),
        legend.key.size = unit(0.5,"cm"))+
  labs(x="Inoculation Timing",y="Relative Abundance",
       fill = "VT")+
  scale_y_continuous(breaks = c(0,100))+
  guides(fill=guide_legend(nrow = 23))
p3
#save plot
ggsave(p3,filename="FigureB6_taxa_plot_vt.png",dpi = 300,width = 6,
       height = 8,units = "in")
```

### Violin plots

```{r}
# plot richness
p1<-ggviolin(alphadiv,x="InoculationTiming",y = "S.obs", add = c("boxplot",
                                                                      "jitter"),
             add.params = list(color= "AMFInoculant",fill = "transparent",
                               alpha = 0.5), fill = "#e8e8e8",
                              color = "transparent",
             palette = c("#999999","#0072B2","#D55E00","#CC79A7"), 
             ylab = "Richness", xlab = "Inoculation Timing")+
  theme_pubr(legend = "bottom",base_size = 20)+
  theme(axis.text.x = element_text(angle = -45,hjust = 0))
p1
# save plot
ggsave(p1,filename = "Figure3.4_observed_richness.png",dpi = 300,width = 8,
       height = 7,units = "in")

# plot Shannon
p2<-ggviolin(alphadiv,x="InoculationTiming",y = "shannon", add = c("boxplot",
                                                                      "jitter"),
             add.params = list(color= "AMFInoculant",alpha=0.5,fill = "transparent"),
             fill = "#e8e8e8",color = "transparent",
             palette = c("#999999","#0072B2","#D55E00",
                          "#CC79A7"), 
             ylab = "Shannon Diversity Index H'", xlab = "Inoculation Timing")+
  theme_pubr(legend = "bottom",base_size = 20)+
  theme(axis.text.x = element_text(angle = -45,hjust = 0))+
  scale_y_continuous(limits = c(1,4))
p2
# save plot
ggsave(p2,filename = "FigureB7_shannon.png",dpi = 300,width = 8,
       height = 7,units = "in")

# plot evenness
p3<-ggviolin(alphadiv,x="InoculationTiming",y = "evenness", add = c("boxplot",
                                                                      "jitter"),
             add.params = list(color= "AMFInoculant",alpha=0.5,fill = "transparent"),
             fill = "#e8e8e8",color = "transparent",
             palette = c("#999999","#0072B2","#D55E00",
                          "#CC79A7"), 
             ylab = "Evenness", xlab = "Inoculation Timing", 
             legend.title = "AMF Inoculant")+
  theme_pubr(legend = "bottom",base_size = 20)+
  theme(axis.text.x = element_text(angle = -45,hjust = 0))
p3
# save plot
ggsave(p3,filename = "FigureB8_evenness.png",dpi = 300,width = 8,
       height = 7,units = "in")
```
